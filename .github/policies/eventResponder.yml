id: avmEventResponder
name: AVM Event Responder
description: AVM Event Responder
resource: repository
disabled: false

configuration:
  resourceManagementConfiguration:
    eventResponderTasks:
      - description: 'ITA06 - If a new issue or PR is opened add the "Needs: Triage :mag:" label'
        if:
          - or:
            - payloadType: Issues
            - payloadType: Pull_Request
          - isAction:
              action: Opened
        then:
          - addLabel:
              label: 'Needs: Triage :mag:'

      - description: 'ITA08BCP - If "AVM" or "Azure Verified Modules" is mentioned in a new issue, add label of "Type: AVM :a: :v: :m:" on the issue'
        if:
          - or:
            - payloadType: Issues
            - payloadType: Pull_Request
            - payloadType: Issue_Comment
            - payloadType: Pull_Request_Review_Comment            
          - and:
            - or:
              - isAction:
                  action: Opened
              - isAction:
                  action: Created
              - isAction:
                  action: Edited                                    
            - or:
              - bodyContains:
                  pattern: 'AVM'
              - bodyContains:
                  pattern: 'avm'
              - bodyContains:
                  pattern: 'Azure Verified Modules'
              - bodyContains:
                  pattern: 'azure verified modules'                                    
              - commentContains:
                  pattern: 'AVM'
              - commentContains:
                  pattern: 'avm'
              - commentContains:
                  pattern: 'AVM'
              - commentContains:
                  pattern: 'azure verified modules'                  
        then:
          - addLabel:
              label: 'Type: AVM :a: :v: :m:'

      - description: 'ITA09 - When #RR is used in an issue, add the "Needs: Author Feedback :ear:" label'
        if:
          - or:
              - payloadType: Pull_Request_Review_Comment
              - payloadType: Issue_Comment
          - commentContains:
              pattern: '#RR'
        then:
          - addLabel:
              label: 'Needs: Author Feedback :ear:'

      - description: 'ITA10 - When #wontfix is used in an issue, mark it by using the label of "Status: Won''t Fix :broken_heart:"'
        if:
          - or:
              - payloadType: Pull_Request_Review_Comment
              - payloadType: Issue_Comment
          - commentContains:
              pattern: '#wontfix'
        then:
          - addLabel:
              label: 'Status: Won''t Fix :broken_heart:'
          - closeIssue

      - description: 'ITA11 - When a reply from anyone to an issue occurs, remove the "Needs: Author Feedback :ear:" label and label with "Needs: Attention :wave:"'
        if:
          - or:
              - payloadType: Pull_Request_Review_Comment
              - payloadType: Issue_Comment
          - not:
              isAction:
                action: Closed
          - hasLabel:
              label: 'Needs: Author Feedback :ear:'
        then:
          - removeLabel:
              label: 'Needs: Author Feedback :ear:'
          - addLabel:
              label: 'Needs: Attention :wave:'

      - description: 'ITA12 - Clean email replies on every comment'
        if:
          - payloadType: Issue_Comment
        then:
          - cleanEmailReply

      # - description: 'TEST1 - If the type is feature request, assign the "Type: Feature Request :heavy_plus_sign:" label on the issue'
      #   if:
      #     - or:
      #       - payloadType: Issues
      #       - payloadType: Issue_Comment
      #     - and:
      #       - or:
      #         - isAction:
      #             action: Opened
      #         - isAction:
      #             action: Created
      #         - isAction:
      #             action: Edited
      #       - or:
      #         - bodyContains:
      #             pattern: '+ Feature Request'
      #         - commentContains:
      #             pattern: '+ Feature Request'
      #   then:
      #     - addLabel:
      #         label: 'Type: Feature Request :heavy_plus_sign:'
      #     - removeLabel:
      #         label: 'Type: Bug :bug:'
      #     - removeLabel:
      #         label: 'Type: Security Bug :lock:'

      # - description: 'TEST2 - If the type is bug, assign the "Type: Bug :bug:" label on the issue'
      #   if:
      #     - or:
      #       - payloadType: Issues
      #       - payloadType: Issue_Comment
      #     - and:
      #       - or:
      #         - isAction:
      #             action: Opened
      #         - isAction:
      #             action: Created
      #         - isAction:
      #             action: Edited
      #       - or:
      #         - bodyContains:
      #             pattern: '+ Bug'
      #         - commentContains:
      #             pattern: '+ Bug'
      #   then:
      #     - addLabel:
      #         label: 'Type: Bug :bug:'
      #     - removeLabel:
      #         label: 'Type: Feature Request :heavy_plus_sign:'
      #     - removeLabel:
      #         label: 'Type: Security Bug :lock:'

      # - description: 'TEST3 - If the type is security bug, assign the "Type: Security Bug :lock:" label on the issue'
      #   if:
      #     - or:
      #       - payloadType: Issues
      #       - payloadType: Issue_Comment
      #     - and:
      #       - or:
      #         - isAction:
      #             action: Opened
      #         - isAction:
      #             action: Created
      #         - isAction:
      #             action: Edited
      #       - or:
      #         - bodyContains:
      #             pattern: '+ Security Bug'
      #         - commentContains:
      #             pattern: '+ Security Bug'
      #   then:
      #     - addLabel:
      #         label: 'Type: Security Bug :lock:'
      #     - removeLabel:
      #         label: 'Type: Bug :bug:'
      #     - removeLabel:
      #         label: 'Type: Feature Request :heavy_plus_sign:'

      # - description: 'ITA13 - If the language is set to Bicep in the Module proposal, assign the "Language: Bicep :muscle:" label on the issue'
      #   if:
      #     - or:
      #       - payloadType: Issues
      #       - payloadType: Issue_Comment
      #     - and:
      #       - or:
      #         - isAction:
      #             action: Opened
      #         - isAction:
      #             action: Created
      #         - isAction:
      #             action: Edited
      #       - or:
      #         - bodyContains:
      #             pattern: '* Bicep'
      #         - commentContains:
      #             pattern: '* Bicep'
      #   then:
      #     - addLabel:
      #         label: 'Language: Bicep :muscle:'
      #     - removeLabel:
      #         label: 'Language: Terraform :globe_with_meridians:'

      # - description: 'ITA14 - If the language is set to Terraform in the Module proposal, assign the "Language: Terraform :globe_with_meridians:" label on the issue'
      #   if:
      #     - or:
      #       - payloadType: Issues
      #       - payloadType: Issue_Comment
      #     - and:
      #       - or:
      #         - isAction:
      #             action: Opened
      #         - isAction:
      #             action: Created
      #         - isAction:
      #             action: Edited
      #       - or:
      #         - bodyContains:
      #             pattern: '* Terraform'
      #         - commentContains:
      #             pattern: '* Terraform'
      #   then:
      #     - addLabel:
      #         label: 'Language: Terraform :globe_with_meridians:'
      #     - removeLabel:
      #         label: 'Language: Bicep :muscle:'
  
      - description: 'ITA13 - If the language is set to Bicep in the Module proposal, assign the "Language: Bicep :muscle:" label on the issue'      
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - bodyContains:
              pattern: |
                ### Bicep or Terraform?

                Bicep
        then:
          - addLabel:
              label: 'Language: Bicep :muscle:'

      - description: 'ITA14 - If the language is set to Terraform in the Module proposal, assign the "Language: Terraform :globe_with_meridians:" label on the issue'
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - bodyContains:
              pattern: |
                ### Bicep or Terraform?

                Terraform
        then:
          - addLabel:
              label: 'Language: Terraform :globe_with_meridians:'

      - description: 'ITA15 - remove the "Needs: Triage" label from a PR, if it already has a "Type: XYZ" label assigned at the time of creating it.'
        if:
          - payloadType: Pull_Request
          - or:
            - hasLabel:
                label: 'Type: Bug :bug:'
            - hasLabel:
                label: 'Type: Documentation :page_facing_up:'
            - hasLabel:
                label: 'Type: Duplicate :palms_up_together:'
            - hasLabel:
                label: 'Type: Feature Request :heavy_plus_sign:'
            - hasLabel:
                label: 'Type: Hygiene :broom:'
            - hasLabel:
                label: 'Type: New Module Proposal :bulb:'
            - hasLabel:
                label: 'Type: Question/Feedback :raising_hand:'
            - hasLabel:
                label: 'Type: Security Bug :lock:'
            - hasLabel:
                label: 'Type: AVM :a: :v: :m:'
          - isAction:
              action: Opened
        then:
          - removeLabel:
              label: 'Needs: Triage :mag:'

      - description: 'ITA16 - Add the "Status: Owners Identified :metal:" label when someone is assigned to a Module Proposal'
        if:
          - payloadType: Issues
          - not:
              isAction:
                action: Closed
          - hasLabel:
              label: 'Type: New Module Proposal :bulb:'
          - isAssignedToSomeone
        then:
          - addLabel:
              label: 'Status: Owners Identified :metal:'

      - description: 'ITA17 - If the issue author says they want to be the module owner, assign the issue to the author and respond to them.'
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - bodyContains:
              pattern: |
                ### Do you want to be the owner of this module?

                Yes
        then:
          - assignTo:
              author: true
          - addReply:
              reply: |
                @${issueAuthor}, thanks for volunteering to be a module owner! 
                
                **Please don't start the development just yet!**
                
                The AVM core team will review this module proposal and respond to you first. Thank you!

      - description: 'ITA18 - Send automatic response to the issue author if they don''t want to be module owner and don''t have any candidate in mind. Assign the "Needs: Module Owner :mega:" label.'
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - bodyContains:
              pattern: |
                ### Do you want to be the owner of this module?

                No

                ### Module Owner's GitHub Username (handle)

                _No response_
        then:
          - addLabel:
              label: 'Needs: Module Owner :mega:'
          - addReply:
              reply: |
                @${issueAuthor}, thanks for submitting this module proposal! 
                
                The AVM core team will review it and will try to find a module owner.

      - description: 'ITA19 - Send automatic response to the issue author if they don''t want to be module owner but have a candidate in mind. Assign the "Status: Owners Identified :metal:" label.'
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - bodyContains:
              pattern: |
                ### Do you want to be the owner of this module?

                No
          - not:
              bodyContains:
                pattern: |
                  ### Module Owner's GitHub Username (handle)

                  _No response_
        then:
          - addLabel:
              label: 'Status: Owners Identified :metal:'
          - addReply:
              reply: |
                @${issueAuthor}, thanks for submitting this module proposal with a module owner in mind! 
                
                **Please don't start the development just yet!**
                
                The AVM core team will review this module proposal and respond to you and/or the module owner first. Thank you!

      - description: 'ITA20 - If the type is feature request, assign the "Type: Feature Request :heavy_plus_sign:" label on the issue'
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - bodyContains:
              pattern: |
                ### Issue Type?

                Feature Request
        then:
          - addLabel:
              label: 'Type: Feature Request :heavy_plus_sign:'

      - description: 'ITA21 - If the type is bug, assign the "Type: Bug :bug:" label on the issue'
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - bodyContains:
              pattern: |
                ### Issue Type?

                Bug
        then:
          - addLabel:
              label: 'Type: Bug :bug:'

      - description: 'ITA22 - If the type is security bug, assign the "Type: Security Bug :lock:" label on the issue'
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - bodyContains:
              pattern: |
                ### Issue Type?

                Security Bug
        then:
          - addLabel:
              label: 'Type: Security Bug :lock:'

      # - description: Sync labels with issues on all pull request events
      #   if:
      #     - or:
      #         - payloadType: Pull_Request
      #         - payloadType: Pull_Request_Review
      #         - payloadType: Pull_Request_Review_Comment
      #     - not:
      #         isAction:
      #           action: Closed
      #   then:
      #     - labelSync:
      #         pattern: 'Needs: Attention :wave:'
      #     - labelSync:
      #         pattern: 'Needs: Immediate Attention :bangbang:'
      #     - labelSync:
      #         pattern: 'Needs: Author Feedback :ear:'
      #     - labelSync:
      #         pattern: 'Needs: External Changes :hammer_and_pick:'
      #     - labelSync:
      #         pattern: 'Needs: More Evidence :balance_scale:'
      #     - labelSync:
      #         pattern: 'Needs: Triage :mag:'
      #     - labelSync:
      #         pattern: 'Needs: Module Owner :mega:'
      #     - labelSync:
      #         pattern: 'Status: Awaiting Release To Be Cut :scissors:'
      #     - labelSync:
      #         pattern: 'Status: Do Not Merge :no_entry:'
      #     - labelSync:
      #         pattern: 'Status: External Contribution :earth_africa:'
      #     - labelSync:
      #         pattern: 'Status: Fixed :white_check_mark:'
      #     - labelSync:
      #         pattern: 'Status: Help Wanted :sos:'
      #     - labelSync:
      #         pattern: 'Status: In Triage :mag:'
      #     - labelSync:
      #         pattern: 'Status: Invalid :x:'
      #     - labelSync:
      #         pattern: 'Status: Long Term :hourglass_flowing_sand:'
      #     - labelSync:
      #         pattern: 'Status: No Recent Activity :zzz:'
      #     - labelSync:
      #         pattern: 'Status: Won't Fix :broken_heart:'
      #     - labelSync:
      #         pattern: 'Status: Migrate from CARML :articulated_lorry:'
      #     - labelSync:
      #         pattern: 'Status: Migrate from TFVM :articulated_lorry:'
      #     - labelSync:
      #         pattern: 'Status: Owners Identified :metal:'
      #     - labelSync:
      #         pattern: 'Status: Module Available :green_circle:'
      #     - labelSync:
      #         pattern: 'Status: Module Orphaned :eyes:'
      #     - labelSync:
      #         pattern: 'Status: Response Overdue :triangular_flag_on_post:'
      #     - labelSync:
      #         pattern: 'Type: Bug :bug:'
      #     - labelSync:
      #         pattern: 'Type: Documentation :page_facing_up:'
      #     - labelSync:
      #         pattern: 'Type: Duplicate :palms_up_together:'
      #     - labelSync:
      #         pattern: 'Type: Feature Request :heavy_plus_sign:'
      #     - labelSync:
      #         pattern: 'Type: Hygiene :broom:'
      #     - labelSync:
      #         pattern: 'Type: New Module Proposal :bulb:'
      #     - labelSync:
      #         pattern: 'Type: Question/Feedback :raising_hand:'
      #     - labelSync:
      #         pattern: 'Type: Security Bug :lock:'
      #     - labelSync:
      #         pattern: 'Type: AVM :a: :v: :m:'
      #     - labelSync:
      #         pattern: 'Language: Terraform :globe_with_meridians:'
      #     - labelSync:
      #         pattern: 'Language: Bicep :muscle:'
      #     - labelSync:
      #         pattern: 'Class: Resource Module :package:'
      #     - labelSync:
      #         pattern: 'Class: Pattern Module :package:'
      #     - inPrLabel:
      #         label: 'Status: In PR :point_right:'

      - description: 'Sync labels with issues on all pull request events'
        if:
          - or:
              - payloadType: Pull_Request
              - payloadType: Pull_Request_Review
              - payloadType: Pull_Request_Review_Comment
          - not:
              isAction:
                action: Closed
        then:
          - labelSync:
              pattern: documentation
          - labelSync:
              pattern: bug
          # - labelSync:
          #     pattern: Type
          # - labelSync:
          #     pattern: Language
          # - labelSync:
          #     pattern: Class
          # - inPrLabel:
          #     label: 'Status: In PR :point_right:'
